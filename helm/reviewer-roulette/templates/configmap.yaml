apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "reviewer-roulette.fullname" . }}-config
  labels:
    {{- include "reviewer-roulette.labels" . | nindent 4 }}
data:
  config.yaml: |
    server:
      port: {{ .Values.config.server.port }}
      environment: {{ .Values.config.server.environment }}
      language: {{ .Values.config.server.language }}

    gitlab:
      url: {{ .Values.config.gitlab.url }}
      bot_username: {{ .Values.config.gitlab.botUsername }}
      {{- if .Values.config.gitlab.timeout }}
      timeout: {{ .Values.config.gitlab.timeout }}
      {{- end }}

    database:
      postgres:
        host: {{ .Values.config.postgres.host }}
        port: {{ .Values.config.postgres.port }}
        database: {{ .Values.config.postgres.database }}
        user: {{ .Values.config.postgres.user }}
        # password: set via POSTGRES_PASSWORD environment variable from Secret
        ssl_mode: {{ .Values.config.postgres.sslMode }}
        {{- if .Values.config.postgres.maxOpenConns }}
        max_open_conns: {{ .Values.config.postgres.maxOpenConns }}
        {{- end }}
        {{- if .Values.config.postgres.maxIdleConns }}
        max_idle_conns: {{ .Values.config.postgres.maxIdleConns }}
        {{- end }}
        {{- if .Values.config.postgres.connMaxLifetime }}
        conn_max_lifetime: {{ .Values.config.postgres.connMaxLifetime }}
        {{- end }}
      redis:
        host: {{ .Values.config.redis.host }}
        port: {{ .Values.config.redis.port }}
        db: {{ .Values.config.redis.db }}
        # password: set via REDIS_PASSWORD environment variable from Secret
        {{- if .Values.config.redis.poolSize }}
        pool_size: {{ .Values.config.redis.poolSize }}
        {{- end }}

    logging:
      level: {{ .Values.config.logging.level }}
      format: {{ .Values.config.logging.format }}
      output: {{ .Values.config.logging.output }}

    mattermost:
      enabled: {{ .Values.config.mattermost.enabled }}
      {{- if .Values.config.mattermost.channel }}
      channel: {{ .Values.config.mattermost.channel }}
      {{- end }}

    metrics:
      retention_days: {{ .Values.config.metrics.retentionDays }}
      prometheus:
        enabled: {{ .Values.metrics.prometheus.enabled }}
        port: {{ .Values.metrics.prometheus.port }}
        path: {{ .Values.metrics.prometheus.path }}

    scheduler:
      enabled: {{ .Values.scheduler.enabled }}
      {{- if .Values.scheduler.dailyNotificationTime }}
      time: {{ .Values.scheduler.dailyNotificationTime | quote }}
      {{- end }}
      {{- if .Values.scheduler.badgeEvaluationTime }}
      badge_evaluation_time: {{ .Values.scheduler.badgeEvaluationTime | quote }}
      {{- end }}
      {{- if .Values.scheduler.timezone }}
      timezone: {{ .Values.scheduler.timezone | quote }}
      {{- end }}
      {{- if hasKey .Values.scheduler "skipWeekends" }}
      skip_weekends: {{ .Values.scheduler.skipWeekends }}
      {{- end }}
      {{- if hasKey .Values.scheduler "skipHolidays" }}
      skip_holidays: {{ .Values.scheduler.skipHolidays }}
      {{- end }}

    roulette:
      cache_ttl: {{ .Values.config.roulette.cacheTTL }}
      max_recent_reviews: {{ .Values.config.roulette.maxRecentReviews }}
      weights:
        current_load: {{ .Values.config.roulette.weights.currentLoad }}
        recent_review: {{ .Values.config.roulette.weights.recentReview }}
        expertise_bonus: {{ .Values.config.roulette.weights.expertiseBonus }}
      expertise:
        dev:
          {{- range .Values.config.roulette.expertise.dev }}
          - {{ . | quote }}
          {{- end }}
        ops:
          {{- range .Values.config.roulette.expertise.ops }}
          - {{ . | quote }}
          {{- end }}

    {{- if .Values.config.availability }}
    availability:
      cache_ttl: {{ .Values.config.availability.cacheTTL }}
      ooo_keywords:
        {{- range .Values.config.availability.oooKeywords }}
        - {{ . | quote }}
        {{- end }}
    {{- end }}

    teams:
      {{- range .Values.config.teams }}
      - name: {{ .name }}
        members:
          {{- range .members }}
          - username: {{ .username }}
            role: {{ .role }}
          {{- end }}
      {{- end }}

    {{- if .Values.config.badges }}
    badges:
      {{- range .Values.config.badges }}
      - name: {{ .name | quote }}
        display_name: {{ .displayName | quote }}
        description: {{ .description | quote }}
        icon: {{ .icon | quote }}
        tier: {{ .tier | quote }}
        criteria:
          metric: {{ .criteria.metric }}
          operator: {{ .criteria.operator | quote }}
          value: {{ .criteria.value }}
          period: {{ .criteria.period }}
      {{- end }}
    {{- end }}
