# Default values for reviewer-roulette.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Number of replicas (ignored if autoscaling is enabled)
replicaCount: 2

# Docker image configuration
image:
  repository: ghcr.io/aimd54/gitlab-reviewer-roulette
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# Service Account configuration
serviceAccount:
  # Specifies whether a service account should be created
  # Set to true once serviceaccount.yaml template is created
  create: false
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# Pod annotations (e.g., for Prometheus scraping)
podAnnotations: {}

# Pod labels
podLabels: {}

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# Container security context
securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000
  allowPrivilegeEscalation: false

# Service configuration
service:
  type: ClusterIP
  port: 8080
  # nodePort: 30080  # Only used if type is NodePort
  # loadBalancerIP: ""  # Only used if type is LoadBalancer
  annotations: {}
  labels: {}

# Ingress configuration
ingress:
  enabled: false
  className: "nginx"
  annotations: {}
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: reviewer-roulette.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: reviewer-roulette-tls
  #    hosts:
  #      - reviewer-roulette.example.com

# Resource limits and requests
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

# Init container (migration) resources
initResources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 200m
    memory: 256Mi

# Horizontal Pod Autoscaler
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  # targetMemoryUtilizationPercentage: 80

# Liveness probe configuration
livenessProbe:
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3

# Readiness probe configuration
readinessProbe:
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3

# Node selector for pod assignment
nodeSelector: {}

# Tolerations for pod assignment
tolerations: []

# Affinity for pod assignment
affinity: {}
  # podAntiAffinity:
  #   preferredDuringSchedulingIgnoredDuringExecution:
  #     - weight: 100
  #       podAffinityTerm:
  #         labelSelector:
  #           matchExpressions:
  #             - key: app.kubernetes.io/name
  #               operator: In
  #               values:
  #                 - reviewer-roulette
  #         topologyKey: kubernetes.io/hostname

# PodDisruptionBudget
podDisruptionBudget:
  enabled: false
  minAvailable: 1
  # maxUnavailable: 1

# Metrics configuration
metrics:
  prometheus:
    enabled: true
    port: 9090
    path: /metrics

  # Service for Prometheus scraping
  service:
    annotations: {}
      # prometheus.io/scrape: "true"
      # prometheus.io/port: "9090"
      # prometheus.io/path: "/metrics"

  # ServiceMonitor for Prometheus Operator
  serviceMonitor:
    enabled: false
    # namespace: monitoring
    interval: 30s
    scrapeTimeout: 10s
    labels: {}

# Scheduler configuration
scheduler:
  enabled: true
  dailyNotificationTime: "09:00"  # Format: HH:MM
  badgeEvaluationTime: "0 2 * * *"  # Cron format: 2 AM daily
  timezone: "UTC"
  skipWeekends: true
  skipHolidays: false

# Application configuration
config:
  server:
    port: 8080
    environment: production
    language: en  # en or fr

  gitlab:
    url: "https://gitlab.example.com"
    token: ""  # REQUIRED: Set via --set or use existing secret
    botUsername: "reviewer-roulette-bot"
    webhookSecret: ""  # REQUIRED: Set via --set or use existing secret
    timeout: 30  # seconds

  postgres:
    host: "postgresql"  # External PostgreSQL host
    port: 5432
    database: "reviewer_roulette"
    user: "postgres"
    password: ""  # REQUIRED: Set via --set or use existing secret
    sslMode: "disable"  # disable, require, verify-ca, verify-full
    maxOpenConns: 25
    maxIdleConns: 5
    connMaxLifetime: 300  # seconds

  redis:
    host: "redis-master"  # External Redis host
    port: 6379
    password: ""  # Optional: Set if Redis requires authentication
    db: 0
    poolSize: 10

  mattermost:
    enabled: false
    webhookURL: ""  # Optional: Set if Mattermost notifications are enabled
    channel: "#reviews"

  logging:
    level: "info"  # debug, info, warn, error
    format: "json"  # json or console
    output: "stdout"  # stdout or file path

  metrics:
    retentionDays: 0  # 0 = forever

  roulette:
    cacheTTL: 300  # seconds (5 minutes)
    maxRecentReviews: 5
    weights:
      currentLoad: 10  # penalty per active review
      recentReview: 5  # penalty if reviewed in last 24h
      expertiseBonus: 2  # bonus for file expertise match
    expertise:
      dev:
        - "*.java"
        - "*.js"
        - "*.jsx"
        - "*.ts"
        - "*.tsx"
        - "*.go"
        - "*.py"
        - "*.rb"
        - "*.php"
        - "*.cs"
        - "*.cpp"
        - "*.c"
        - "*.h"
      ops:
        - "*.yml"
        - "*.yaml"
        - "*.pp"
        - "Dockerfile"
        - "*.tf"
        - "*.sh"
        - "*.bash"
        - "docker-compose*.yml"
        - "*.hcl"

  availability:
    cacheTTL: 300  # seconds (5 minutes)
    oooKeywords:
      - "vacation"
      - "vacances"
      - "ooo"
      - "out of office"
      - "pto"
      - "holiday"
      - "cong√©"
      - "absent"

  # Teams configuration - CUSTOMIZE THIS FOR YOUR ORGANIZATION
  teams:
    - name: team-frontend
      members:
        - username: alice
          role: dev
        - username: bob
          role: dev
    - name: team-backend
      members:
        - username: charlie
          role: dev
        - username: david
          role: ops

  # Badges configuration - Adjust thresholds for your team size
  badges:
    - name: "speed_demon"
      displayName: "Speed Demon"
      description: "‚ö° Reviews in less than 2 hours on average"
      icon: "‚ö°"
      tier: "bronze"
      criteria:
        metric: avg_ttfr
        operator: "<"
        value: 120  # minutes
        period: month

    - name: "thorough_reviewer"
      displayName: "Thorough Reviewer"
      description: "üîç Averages 5+ comments per review"
      icon: "üîç"
      tier: "bronze"
      criteria:
        metric: avg_comment_count
        operator: ">="
        value: 5
        period: month

    - name: "team_player"
      displayName: "Team Player"
      description: "ü§ù Most reviews completed this month"
      icon: "ü§ù"
      tier: "gold"
      criteria:
        metric: completed_reviews
        operator: "top"
        value: 1
        period: "month"

    - name: "mentor"
      displayName: "Mentor"
      description: "üåü Most external (cross-team) reviews"
      icon: "üåü"
      tier: "gold"
      criteria:
        metric: external_reviews
        operator: "top"
        value: 1
        period: "month"

# External PostgreSQL (if not using a managed database)
postgresql:
  enabled: false
  # If enabled, will create a PostgreSQL StatefulSet
  auth:
    username: postgres
    password: postgres
    database: reviewer_roulette
  service:
    port: 5432

# External Redis (if not using a managed cache)
redis:
  enabled: false
  # If enabled, will create a Redis StatefulSet
  auth:
    enabled: false
    password: ""
  service:
    port: 6379
